openapi: 3.0.4
info:
  title: Tagging Service API
  version: 0.1.1
  description: |
    The **Tagging Service API** provides RESTful access to all tag-related operations—creation, updates, deletion, linking, and querying of tags and their relationships.
    It also supports metadata assignment for tagged entities such as images, documents, or video stills.

    ## Principles
    - **RESTful architecture** — resource-based URIs and standard HTTP verbs (GET, POST, PATCH, DELETE)
    - **JSON payloads** — all requests and responses use JSON
    - **Frontend-controlled authentication** — only frontend clients (CLI, UI) interact with the API through validated tokens (except for development/testing)

servers:
  - url: http://localhost:8000/api/v1
    description: Local development

tags:
  - name: tags
    description: Manage tags, aliases, compositions, and relationships
  - name: entities
    description: Manage entities and their assigned tags
  - name: utilities
    description: Retrieve shared lookup data such as contexts and parts of speech

paths:
  /tags:
    post:
      tags: [tags]
      summary: Create a new tag
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TagInput"
      responses:
        "201":
          description: Tag created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Tag"
        "400":
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Tag already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    get:
      tags: [tags]
      summary: List all tags
      parameters:
        - in: query
          name: limit
          schema: { type: integer, example: 25 }
        - in: query
          name: offset
          schema: { type: integer, example: 0 }
      responses:
        "200":
          description: Paginated list of tags
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/PaginatedResponse"
                  - type: object
                    properties:
                      results:
                        type: array
                        items:
                          $ref: "#/components/schemas/Tag"

  /tags/{id}:
    get:
      tags: [tags]
      summary: Retrieve tag by ID
      parameters:
        - $ref: "#/components/parameters/TagId"
      responses:
        "200":
          description: Tag found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Tag"
        "404":
          description: Tag not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    patch:
      tags: [tags]
      summary: Update tag metadata
      parameters:
        - $ref: "#/components/parameters/TagId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TagInput"
      responses:
        "200":
          description: Tag updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Tag"
        "404":
          description: Tag not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    delete:
      tags: [tags]
      summary: Delete a tag
      parameters:
        - $ref: "#/components/parameters/TagId"
      responses:
        "200":
          description: Tag deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: deleted
        "404":
          description: Tag not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /tags/{id}/aliases:
    get:
      tags: [tags]
      summary: Get tag aliases
      parameters:
        - $ref: "#/components/parameters/TagId"
      responses:
        "200":
          description: List of aliases
          content:
            application/json:
              schema:
                type: object
                properties:
                  aliases:
                    type: array
                    items:
                      $ref: "#/components/schemas/TagAlias"
        "404":
          description: Tag not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    patch:
      tags: [tags]
      summary: Update tag aliases
      parameters:
        - $ref: "#/components/parameters/TagId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AliasUpdate"
      responses:
        "200":
          description: Aliases updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  tag_id: { type: string, format: uuid }
                  aliases:
                    type: array
                    items:
                      $ref: "#/components/schemas/TagAlias"
        "404":
          description: Tag not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /tags/{id}/relationships:
    get:
      tags: [tags]
      summary: Get tag relationships
      parameters:
        - $ref: "#/components/parameters/TagId"
      responses:
        "200":
          description: List of tag relationships
          content:
            application/json:
              schema:
                type: object
                properties:
                  relationships:
                    type: array
                    items:
                      $ref: "#/components/schemas/TagRelationship"
        "404":
          description: Tag not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    patch:
      tags: [tags]
      summary: Update tag relationships
      parameters:
        - $ref: "#/components/parameters/TagId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RelationshipUpdate"
      responses:
        "200":
          description: Updated relationships
          content:
            application/json:
              schema:
                type: object
                properties:
                  relationships:
                    type: array
                    items:
                      $ref: "#/components/schemas/TagRelationship"
        "404":
          description: Tag not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /tags/{id}/compositions:
    get:
      tags: [tags]
      summary: Get tag composition components
      parameters:
        - $ref: "#/components/parameters/TagId"
      responses:
        "200":
          description: List of tag components
          content:
            application/json:
              schema:
                type: object
                properties:
                  components:
                    type: array
                    items:
                      $ref: "#/components/schemas/TagComponent"
        "404":
          description: Tag not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    patch:
      tags: [tags]
      summary: Update tag composition components
      parameters:
        - $ref: "#/components/parameters/TagId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CompositionUpdate"
      responses:
        "200":
          description: Updated tag components
          content:
            application/json:
              schema:
                type: object
                properties:
                  base_tag_id: { type: string, format: uuid }
                  components:
                    type: array
                    items:
                      $ref: "#/components/schemas/TagComponent"
        "404":
          description: Tag not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /tags/{id}/ratings:
    patch:
      tags: [tags]
      summary: Rate tag in context
      parameters:
        - $ref: "#/components/parameters/TagId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ContextualRatingUpdate"
      responses:
        "200":
          description: Contextual ratings applied
          content:
            application/json:
              schema:
                type: object
                properties:
                  tag_id: { type: string, format: uuid }
                  ratings:
                    type: array
                    items:
                      $ref: "#/components/schemas/TagContextualRatingInput"
        "404":
          description: Tag or context not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /tags/{id}/relationship_ratings:
    patch:
      tags: [tags]
      summary: Rate tag relationships
      parameters:
        - $ref: "#/components/parameters/TagId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RelationshipRatingUpdate"
      responses:
        "200":
          description: Relationship ratings recorded
          content:
            application/json:
              schema:
                type: object
                properties:
                  tag_a_id: { type: string, format: uuid }
                  ratings:
                    type: array
                    items:
                      $ref: "#/components/schemas/TagRelationshipRatingInput"
        "404":
          description: Tag or related tag not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /entities:
    post:
      tags: [entities]
      summary: Create a new entity
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EntityInput"
      responses:
        "201":
          description: Entity created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Entity"
        "400":
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    get:
      tags: [entities]
      summary: List all entities
      parameters:
        - in: query
          name: limit
          schema: { type: integer, example: 25 }
        - in: query
          name: offset
          schema: { type: integer, example: 0 }
      responses:
        "200":
          description: Paginated list of entities
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/PaginatedResponse"
                  - type: object
                    properties:
                      results:
                        type: array
                        items:
                          $ref: "#/components/schemas/Entity"

  /entities/{id}:
    get:
      tags: [entities]
      summary: Retrieve entity by ID
      parameters:
        - $ref: "#/components/parameters/EntityId"
      responses:
        "200":
          description: Entity found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Entity"
        "404":
          description: Entity not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    patch:
      tags: [entities]
      summary: Update an entity
      parameters:
        - $ref: "#/components/parameters/EntityId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EntityInput"
      responses:
        "200":
          description: Entity updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Entity"
        "404":
          description: Entity not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    delete:
      tags: [entities]
      summary: Delete an entity
      parameters:
        - $ref: "#/components/parameters/EntityId"
      responses:
        "200":
          description: Entity deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: deleted
        "404":
          description: Entity not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /entities/{id}/tags:
    get:
      tags: [entities]
      summary: List tags assigned to an entity
      parameters:
        - $ref: "#/components/parameters/EntityId"
      responses:
        "200":
          description: Tag assignments
          content:
            application/json:
              schema:
                type: object
                properties:
                  tags:
                    type: array
                    items:
                      $ref: "#/components/schemas/EntityTagAssignment"
        "404":
          description: Entity not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    patch:
      tags: [entities]
      summary: Assign or unassign tags to entity
      parameters:
        - $ref: "#/components/parameters/EntityId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EntityTagUpdate"
      responses:
        "200":
          description: Tags updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  entity_id: { type: string, format: uuid }
                  tags:
                    type: array
                    items:
                      $ref: "#/components/schemas/EntityTagAssignment"
        "404":
          description: Entity or tags not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /entities/{id}/purpose:
    patch:
      tags: [entities]
      summary: Update purpose(s) for an entity
      parameters:
        - $ref: "#/components/parameters/EntityId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EntityPurposeUpdate"
      responses:
        "200":
          description: Updated purposes
          content:
            application/json:
              schema:
                type: object
                properties:
                  entity_id: { type: string, format: uuid }
                  purposes:
                    type: array
                    items:
                      $ref: "#/components/schemas/EntityPurposeInput"
        "404":
          description: Entity or purpose tag not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /entities/{id}/relationships:
    get:
      tags: [entities]
      summary: Retrieve entity relationships
      parameters:
        - $ref: "#/components/parameters/EntityId"
      responses:
        "200":
          description: Related entities
          content:
            application/json:
              schema:
                type: object
                properties:
                  relationships:
                    type: array
                    items:
                      $ref: "#/components/schemas/EntityRelationship"
        "404":
          description: Entity not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    patch:
      tags: [entities]
      summary: Update entity relationships
      parameters:
        - $ref: "#/components/parameters/EntityId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EntityRelationshipUpdate"
      responses:
        "200":
          description: Relationships updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  entity_a_id: { type: string, format: uuid }
                  relationships:
                    type: array
                    items:
                      $ref: "#/components/schemas/EntityRelationshipInput"
        "404":
          description: Entity or target not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /contexts:
    get:
      tags: [utilities]
      summary: Retrieve all tagging contexts
      responses:
        "200":
          description: List of contexts
          content:
            application/json:
              schema:
                type: object
                properties:
                  contexts:
                    type: array
                    items:
                      $ref: "#/components/schemas/Context"

  /parts-of-speech:
    get:
      tags: [utilities]
      summary: Retrieve all parts of speech
      responses:
        "200":
          description: List of parts of speech
          content:
            application/json:
              schema:
                type: object
                properties:
                  parts_of_speech:
                    type: array
                    items:
                      $ref: "#/components/schemas/PartOfSpeech"

components:
  parameters:
    TagId:
      name: id
      in: path
      required: true
      schema: { type: string, format: uuid }
      description: Unique identifier for the tag
    EntityId:
      name: id
      in: path
      required: true
      schema: { type: string, format: uuid }
      description: Unique identifier for the entity

  schemas:
    ErrorResponse:
      type: object
      properties:
        code: { type: integer, example: 404 }
        message: { type: string, example: "Resource not found" }
        details: { type: object }
      required: [code, message]

    PaginatedResponse:
      type: object
      properties:
        results: { type: array, items: {} }
        total: { type: integer, example: 42 }

    Tag:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        display_name: { type: string }
        metadata: { type: object }
        part_of_speech_id: { type: string, format: uuid }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
      example:
        id: "a123e456-78b9-4cde-8123-456789abcdef"
        name: "dog"
        display_name: "Dog"
        metadata: { source: "Label Studio" }

    TagInput:
      type: object
      required: [name]
      properties:
        name: { type: string }
        display_name: { type: string }
        metadata: { type: object }
        part_of_speech_id: { type: string, format: uuid }

    TagAlias:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }

    AliasUpdate:
      type: object
      properties:
        aliases:
          type: array
          items: { type: string }

    TagRelationship:
      type: object
      properties:
        tag_a_id: { type: string, format: uuid }
        tag_b_id: { type: string, format: uuid }
        relationship_type_id: { type: string, format: uuid }
        description: { type: string }

    RelationshipUpdate:
      type: object
      properties:
        relationships:
          type: array
          items:
            $ref: "#/components/schemas/TagRelationshipInput"

    TagRelationshipInput:
      type: object
      properties:
        tag_b_id: { type: string, format: uuid }
        relationship_type_id: { type: string, format: uuid }
        description: { type: string }

    TagComponent:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        position: { type: integer }

    CompositionUpdate:
      type: object
      properties:
        components:
          type: array
          items:
            $ref: "#/components/schemas/TagComponentInput"

    TagComponentInput:
      type: object
      properties:
        id: { type: string, format: uuid }
        position: { type: integer }

    ContextualRatingUpdate:
      type: object
      properties:
        contextual_ratings:
          type: array
          items:
            $ref: "#/components/schemas/TagContextualRatingInput"

    RelationshipRatingUpdate:
      type: object
      properties:
        relationship_ratings:
          type: array
          items:
            $ref: "#/components/schemas/TagRelationshipRatingInput"

    TagContextualRatingInput:
      type: object
      properties:
        context_id: { type: string, format: uuid }
        rating_id: { type: string, format: uuid }
        user_id: { type: string, format: uuid }

    TagRelationshipRatingInput:
      type: object
      properties:
        tag_b_id: { type: string, format: uuid }
        context_id: { type: string, format: uuid }
        rating_id: { type: string, format: uuid }

    Entity:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        location: { type: string }
        is_primary: { type: boolean }
        metadata: { type: object }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }

    EntityInput:
      type: object
      required: [name]
      properties:
        name: { type: string }
        location: { type: string }
        is_primary: { type: boolean }
        metadata: { type: object }

    EntityTagAssignment:
      type: object
      properties:
        tag: { $ref: "#/components/schemas/Tag" }
        context_id: { type: string, format: uuid }
        metadata: { type: object }

    EntityTagAssignmentInput:
      type: object
      properties:
        tag_id: { type: string, format: uuid }
        context_id: { type: string, format: uuid }
        metadata: { type: object }

    EntityTagUpdate:
      type: object
      properties:
        tags:
          type: array
          items:
            $ref: "#/components/schemas/EntityTagAssignmentInput"

    EntityPurposeInput:
      type: object
      properties:
        purpose_tag_id: { type: string, format: uuid }
        is_primary: { type: boolean }

    EntityPurposeUpdate:
      type: object
      properties:
        purposes:
          type: array
          items:
            $ref: "#/components/schemas/EntityPurposeInput"

    EntityRelationship:
      type: object
      properties:
        entity_a_id: { type: string, format: uuid }
        entity_b_id: { type: string, format: uuid }
        relationship_type_id: { type: string, format: uuid }

    EntityRelationshipInput:
      type: object
      properties:
        entity_b_id: { type: string, format: uuid }
        relationship_type_id: { type: string, format: uuid }

    EntityRelationshipUpdate:
      type: object
      properties:
        relationships:
          type: array
          items:
            $ref: "#/components/schemas/EntityRelationshipInput"

    Context:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        classification_type:
          type: string
          enum: [objective, subjective]
        description: { type: string }
        is_active: { type: boolean }

    PartOfSpeech:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        description: { type: string }
        is_active: { type: boolean }
